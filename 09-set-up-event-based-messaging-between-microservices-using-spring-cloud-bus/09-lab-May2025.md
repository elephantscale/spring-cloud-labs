# **Lab 9: Event-Based Config Refresh with Spring Cloud Bus (Spring Boot 3.4.5, Windows + IntelliJ)**

## **Objective**
Set up an end-to-end demo where **multiple Spring Boot microservices automatically reload configuration** without a restart.  
You will:

1. Run **Kafka + ZooKeeper** locally (event backbone).  
2. Create a **Config Server** that reads properties from **GitHub**.  
3. Build two **client services** that fetch config and refresh via **Spring Cloud Bus**.

Everything is done on **Windows 10/11**, using **PowerShell (Administrator)** and **IntelliJ IDEA**.

---

## **Installing Prerequisites**

| Tool | Install Command / Download | Purpose in this Lab |
|------|----------------------------|---------------------|
| **Java 17 SDK** | `winget install --id EclipseAdoptium.Temurin.17.JDK` | Runtime needed to build & run Spring Boot apps |
| **Git** | `winget install --id Git.Git` | Version control; Config Server pulls files from your GitHub repo |
| **Maven 3.9+** | `winget install --id Apache.Maven`  *(skip if you will use the **mvnw** wrapper generated by Spring Initializr)* | Builds the Java projects |
| **IntelliJ IDEA Community** | `winget install --id JetBrains.IntelliJIDEA.Community` | IDE to edit and run code |
| **curl** | Built-in on Win 10/11. If missing: `winget install Curl.Curl` | Quick HTTP calls to test endpoints |
| **Kafka 3.9.0 + ZooKeeper** | https://archive.apache.org/dist/kafka/3.9.0/kafka_2.12-3.9.0.tgz â†’ extract to **`C:\kafka`** | Event-bus transport for Spring Cloud Bus |

> **After installing Java/Git/Maven**, close and re-open **PowerShell as Administrator** so the new tools are on the `PATH`.

---

## **GitHub Setup â€” do this once**

> We need a Git repo that the Config Server can read.

| Step | What to do | Expected Result |
|------|------------|-----------------|
| 1 | Sign in to https://github.com (or create an account). Grab your **username** from the topâ€‘right avatar â€” youâ€™ll replace `<your-username>` below. | â€” |
| 2 | Click **â•â€¯New â†’ New repository**.<br>â€¢ **Name**: `config-repo`<br>â€¢ **â˜‘â€¯Add a README** âœ”<br>Click **Create repository**. | Repo page shows *README.md* |
| 3 | Click **Add file â†’ Create new file**.<br>â€¢ **Filename**: `user-service.properties` | File appears in the repo |
| 4 | Open the file and click âœï¸ Edit â†’ add the line: `message=Default message` | â€” |
| 5 | Scroll down â†’ **Commit new file**. | â€” |

---

## Part 1 â€“ Kafka & ZooKeeper

> **Tech Explainerâ€‚â€”â€‚Kafka & ZooKeeper**  
> **Kafka** is a distributed event-streaming platform. **ZooKeeper** coordinates Kafka brokers.  
> In this lab they shuttle Spring Cloud Bus events so every microservice learns about config changes.

| Step | Window | Command (run in PowerShell **Admin**) | Expected Output |
|------|--------|----------------------------------------|-----------------|
| **A â€“ Prepare** | â€” | 1. Create folder `C:\kafka`.<br>2. Unzip **kafka_2.12-3.9.0.zip** to `C:\kafka`. | Folder **C:\kafka\kafka_2.12-3.9.0** exists |
| **B â€“ Update ZooKeeper timeout** | 1 | <code>Get-Content 'C:\kafka\kafka_2.12-3.9.0\config\server.properties' &#124; Where-Object { $_ -notmatch '^\s*zookeeper.session.timeout.ms=' } &#124; Set-Content 'C:\kafka\kafka_2.12-3.9.0\config\server.properties'</code><br><br><code>Add-Content 'C:\kafka\kafka_2.12-3.9.0\config\server.properties' "zookeeper.session.timeout.ms=30000"</code> | Line `zookeeper.session.timeout.ms=3000000` is appended to **server.properties** |
| **C â€“ Start ZooKeeper** | 1 | <code>cd C:\kafka\kafka_2.12-3.9.0</code><br><code>.\bin\windows\zookeeper-server-start.bat ..\config\zookeeper.properties</code> | Last line ends with `binding to port 0.0.0.0:2181` |
| **D â€“ Start Kafka Broker** | 2 | <code>cd C:\kafka\kafka_2.12-3.9.0</code><br><code>.\bin\windows\kafka-server-start.bat ..\config\server.properties</code> | Line shows `[KafkaServer id=0] started` |
| **E â€“ List Topics** | 3 | <code>cd C:\kafka\kafka_2.12-3.9.0</code><br><code>.\bin\windows\kafka-topics.bat --list --bootstrap-server localhost:9092</code> | Blank list **or** `__consumer_offsets` |

> **Troubleshoot:** If the ZooKeeper window times out, close it and repeat **C**, then **D**.

---

## **Part 2 - Config Server**

> **Tech Explainer â€” Spring Cloud Config Server**  
> The Config Server is a central place to keep external configuration for all microservices. It serves property files stored on GitHub so that every service boots with the same settings.

### 2.1 Create Project
Make sure you have extracted the starter files for Lab 09
- ğŸ“‚ Place **studentCloud.zip** in `C:\` and **Extract All**.  
- ğŸ“‚ Create folder `C:\studentCloudLabs`.  
- ğŸ“‹ Copy lab09 folder from `C:\studentCloud\starters` â†’ paste into `C:\studentCloudLabs`.

Once lab 9 is extracted, make sure to extract files for config server
- ğŸ—‚ï¸ Inside lab09, unzip service files (e.g., `config-service.zip` â†’ `config-service`).  
- âœ… Verify structure, e.g.:  
  ```
  C:\studentCloudLabs
    â””â”€ lab09
        â””â”€ config-service
  ```

### 2.2 Open in IntelliJ

*File â†’ Openâ€¦* â†’ choose the **configâ€‘server** folder. IntelliJ detects Maven and indexes the project.

### 2.3 Add Dependencies in `pom.xml`
```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-config-server</artifactId>
</dependency>
<dependency>
 <groupId>org.springframework.cloud</groupId>
 <artifactId>spring-cloud-starter-bus-kafka</artifactId>
</dependency>
```

### 2.4 Enable Config Server Annotation

Create or open **`src/main/java/com/microservices/configserver/ConfigServerApplication.java`** and add `@EnableConfigServer` directly under `@SpringBootApplication`:

```java
@SpringBootApplication
@EnableConfigServer
public class ConfigServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(ConfigServerApplication.class, args);
    }
}
```

*(The class already exists; youâ€™re only adding the annotation.)*

### 2.5 `application.properties`

Create/overwrite **`src/main/resources/application.properties`** *(replace `<your-username>` with your GitHub username)*:

```properties
server.port=8888
spring.application.name=config-server

spring.cloud.config.server.git.uri=https://github.com/<your-username>/config-repo
spring.cloud.bus.enabled=true
spring.cloud.stream.kafka.binder.brokers=localhost:9092

management.endpoints.web.exposure.include=health,info,refresh,busrefresh
```

### 2.6 Run in IntelliJ

Rightâ€‘click **ConfigServerApplication.java â†’ Run**, or open IntelliJ Terminal:

```powershell
mvn spring-boot:run
```

Expected console tail:

```
... Started ConfigServerApplication in 6.0 seconds
... Tomcat started on port(s): 8888
```

---

## **Part 3 - Client Service (`user-service`)**

> **Tech Explainer â€” Spring Cloud Bus (Client Side)**  
> Each microservice includes the Spring Cloud Bus starter so it can publish & listen to events over Kafka. When the Config Server broadcasts a **`RefreshRemoteApplicationEvent`**, every client automatically reloads its configuration.

### 3.1 Create Project

Make sure you have extracted the starter files for Lab 09
- ğŸ“‚ Place **studentCloud.zip** in `C:\` and **Extract All**.  
- ğŸ“‚ Create folder `C:\studentCloudLabs`.  
- ğŸ“‹ Copy lab09 folder from `C:\studentCloud\starters` â†’ paste into `C:\studentCloudLabs`.

Once lab 9 is extracted, make sure to extract files for config server
- ğŸ—‚ï¸ Inside lab09, unzip service files (e.g., `user-service.zip` â†’ `user-service`).  
- âœ… Verify structure, e.g.:  
  ```
  C:\studentCloudLabs
    â””â”€ lab09
        â””â”€ user-service
  ```

### 3.2 Open in IntelliJ

(File â†’ Openâ€¦ â†’ choose **user-service**).

### 3.3 Add Dependencies in `pom.xml`
```xml
<dependency>
 <groupId>org.springframework.cloud</groupId>
 <artifactId>spring-cloud-starter-bus-kafka</artifactId>
</dependency>
```

### 3.4 `application.properties`

```properties
server.port=8081
spring.application.name=user-service

spring.cloud.config.uri=http://localhost:8888
spring.cloud.bus.enabled=true
spring.cloud.stream.kafka.binder.brokers=localhost:9092

management.endpoints.web.exposure.include=health,info,refresh
```

### 3.5 Add REST Controller

Create file **`src/main/java/com/microservices/userservice/ConfigController.java`**:

```java
package com.microservices.user_service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RefreshScope
public class ConfigController {

    @Value("${message:Default message}")
    private String message;

    @GetMapping("/message")
    public String getMessage() {
        return message;
    }
}
```

### 3.6 Run in IntelliJ

Run **UserServiceApplication** or:

```powershell
mvn spring-boot:run
```

Expected tail:

```
... Started UserServiceApplication in 5.0 seconds
```

### 3.7 Test endpoint (new PowerShell Admin window)

```powershell
curl.exe http://localhost:8081/message
```

Output:

```
Default message
```

---

## **Part 4 - Broadcast Config Changes**

1. **Edit property file in GitHub Web UI**  
   Open `config-repo/user-service.properties` online â†’ click âœï¸ **Edit** â†’ replace content with:

   ```properties
   message=Hello from Config Server!
   ```

   â†’ **Commit changes**.

2. **Trigger bus refresh** (PowerShell Admin)

   ```powershell
   curl.exe -X POST http://localhost:8888/actuator/busrefresh
   ```

   Expected headers (no body):

   ```
   HTTP/1.1 204 No Content
   Date: <timestamp>
   ```

3. **Verify**

   ```powershell
   curl.exe http://localhost:8081/message
   ```

   Output:

   ```
   Hello from Config Server!
   ```

---

## **Part 5 - Second Client (`product-service`)**

### 5.1 Create Project
Make sure you have extracted the starter files for Lab 09
- ğŸ“‚ Place **studentCloud.zip** in `C:\` and **Extract All**.  
- ğŸ“‚ Create folder `C:\studentCloudLabs`.  
- ğŸ“‹ Copy lab09 folder from `C:\studentCloud\starters` â†’ paste into `C:\studentCloudLabs`.

Once lab 9 is extracted, make sure to extract files for config server
- ğŸ—‚ï¸ Inside lab09, unzip service files (e.g., `product-service.zip` â†’ `product-service`).  
- âœ… Verify structure, e.g.:  
  ```
  C:\studentCloudLabs
    â””â”€ lab09
        â””â”€ product-service
  ```

### 5.2 Open in IntelliJ

(File â†’ Openâ€¦ â†’ choose **product-service**).

### 5.3 Add Dependencies in `pom.xml`
```xml
<dependency>
 <groupId>org.springframework.cloud</groupId>
 <artifactId>spring-cloud-starter-bus-kafka</artifactId>
</dependency>
```

### 5.4 `application.properties`

```properties
server.port=8082
spring.application.name=product-service

spring.cloud.config.uri=http://localhost:8888
spring.cloud.bus.enabled=true
spring.cloud.stream.kafka.binder.brokers=localhost:9092

management.endpoints.web.exposure.include=health,info,refresh
```

### 5.5 Add REST Controller

Create file **`src/main/java/com/microservices/product_service/ConfigController.java`**:

```java
package com.microservices.product_service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RefreshScope
public class ConfigController {

    @Value("${message:Default message}")
    private String message;

    @GetMapping("/message")
    public String getMessage() {
        return message;
    }
}
```

### 5.6 Run in IntelliJ

Run **ProductServiceApplication** or:

```powershell
mvn spring-boot:run
```

Expected tail:

```
... Started ProductServiceApplication in 5.0 seconds
```

### 5.7 Test endpoint (new PowerShell Admin window)

```powershell
curl.exe http://localhost:8082/message
```

Output:

```
Default message
```

---


After running both services, execute:

```powershell
curl.exe -X POST http://localhost:8888/actuator/busrefresh
curl.exe http://localhost:8081/message   # â†’ Hello from Config Server!
curl.exe http://localhost:8082/message   # â†’ Hello from Config Server!
```

---

## **Conclusion**

You now have:

* Kafka + ZooKeeper running on Windows.  
* A Config Server pulling files from GitHub.  
* Two services that **auto-refresh** configuration via Spring Cloud Bus.

A single `POST /actuator/busrefresh` updates every service instantly â€” no restarts, no redeploys. ğŸ‰
