
# **LabÂ 9: Eventâ€‘Based Config Refresh with Spring Cloud Bus (SpringÂ BootÂ 3.4.5, WindowsÂ +Â IntelliJ)**

## **Objective**
Set up an endâ€‘toâ€‘end demo where **multiple Spring Boot microservices automatically reload configuration** without a restart.  
You will:

1. Run **Kafkaâ€¯+â€¯ZooKeeper** locally (event backbone).  
2. Create a **Configâ€¯Server** that reads properties from **GitHub**.  
3. Build two **client services** that fetch config and refresh via **Spring CloudÂ Bus**.

Everything is done on **WindowsÂ 10/11**, using **PowerShell (Administrator)** and **IntelliJÂ IDEA**.

---

## **InstallingÂ Prerequisites**

| Tool | Install Command / Download | Purpose in this Lab |
|------|----------------------------|---------------------|
| **JavaÂ 17â€¯SDK** | `winget install --idÂ EclipseAdoptium.Temurin.17.JDK` | Runtime needed to build & run Spring Boot apps |
| **Git** | `winget install --idÂ Git.Git` | Versionâ€‘control; ConfigÂ Server pulls files from your GitHub repo |
| **MavenÂ 3.9+** | `winget install --idÂ Apache.Maven` Â *(skip if you will use the **mvnw** wrapper generated by Spring Initializr)* | Builds the Java projects |
| **IntelliJÂ IDEAÂ Community** | `winget install --idÂ JetBrains.IntelliJIDEA.Community` | IDE to edit and run code |
| **curl** | Builtâ€‘in on Winâ€¯10/11. If missing: `winget installÂ Curl.Curl` | Quick HTTP calls to test endpoints |
| **KafkaÂ 3.9.0Â +Â ZooKeeper** | <https://archive.apache.org/dist/kafka/3.9.0/kafka_2.12-3.9.0.tgz> â†’ extract to **`C:\kafka`** | Event bus transport for SpringÂ CloudÂ Bus |

> **After installing Java/Git/Maven**, close and reâ€‘open **PowerShell as Administrator** so the new tools are on the `PATH`.

---

## GitHub Setup â€” do this once
> We need a Git repo that the Config Server can read.

| Step | What to do | Expected Result |
|------|------------|-----------------|
| **1** | Sign in to <https://github.com> (or create an account). Grab your **username** from the top-right avatar â€” youâ€™ll replace `<your-username>` below. | â€” |
| **2** | Click **â• New â†’ New repository**<br>â€¢ **Name** â†’ `config-repo`<br>â€¢ **â˜‘ Add a README** (checked)<br>Click **Create repository** | Repo page shows **README.md** |
| **3** | Click **Add file â†’ Create new file**<br>â€¢ **Filename** â†’ `user-service.properties`<br>â€¢ Paste the snippet below, then click **Commit new file**<br><br>```properties<br>message=Hello from Config Server!<br>``` | File appears in the repo |

---

## Part 1 â€“ Kafka & ZooKeeper

> **Tech Explainerâ€‚â€”â€‚Kafka & ZooKeeper**  
> **Kafka** is a distributed event-streaming platform. **ZooKeeper** coordinates Kafka brokers.  
> In this lab they shuttle Spring Cloud Bus events so every microservice learns about config changes.

| Step | Window | Command (run in PowerShell **Admin**) | Expected Output |
|------|--------|---------------------------------------|-----------------|
| **A â€“ Prepare** | â€” | <pre>New-Item -ItemType Directory -Force -Path C:\kafka  # create folder\n# Unzip kafka_2.12-3.9.0.zip to C:\kafka (Explorer â†’ Right-click â†’ Extract All)</pre> | Folder **C:\kafka\kafka_2.12-3.9.0** exists |
| **B â€“ Start ZooKeeper** | 1 | <pre>cd C:\kafka\kafka_2.12-3.9.0\n.\bin\windows\zookeeper-server-start.bat ..\config\zookeeper.properties</pre> | Last line ends with<br>`binding to port 0.0.0.0:2181` |
| **C â€“ Start Kafka Broker** | 2 | <pre>cd C:\kafka\kafka_2.12-3.9.0\n.\bin\windows\kafka-server-start.bat ..\config\server.properties</pre> | Line shows<br>`[KafkaServer id=0] started` |
| **D â€“ List Topics** | 3 | <pre>cd C:\kafka\kafka_2.12-3.9.0\n.\bin\windows\kafka-topics.bat --list --bootstrap-server localhost:9092</pre> | Blank list **or**<br>`__consumer_offsets` |

> **Troubleshoot:** If the ZooKeeper window times out, close it and repeat **B**, then **C**.

---

## **PartÂ 2 â€“ ConfigÂ Server**

> **TechÂ Explainer â€” SpringÂ CloudÂ ConfigÂ Server**  
> The ConfigÂ Server is a central place to keep external configuration for all microservices. It serves property files stored on GitHub so that every service boots with the same settings.

### 2.1Â Â Create Project

| | Setting |
|-|---------|
| **Folder** | `C:\Projects\Lab09\config-server` |
| **Spring Initializr** | <https://start.spring.io> |
| **Group / Artifact / Name** | `com.microservices` / **config-server** / **config-server** |
| **Dependencies** | **CloudÂ Bus**, **ConfigÂ Server**, **Springâ€¯Bootâ€¯Actuator** |

Download ZIP â†’ **ExtractÂ Allâ€¦** to **`C:\Projects\Lab09\config-server`**.

### 2.2Â Â Open in IntelliJ

*FileÂ â†’Â Openâ€¦* â†’ choose the **config-server** folder. IntelliJ detects Maven and indexes the project.

### 2.3Â Â Enable ConfigÂ Server Annotation

Open **`src/main/java/com/microservices/configserver/ConfigServerApplication.java`**  
Add one line just under `@SpringBootApplication`:

```java
@SpringBootApplication
@EnableConfigServer   // <â€‘â€‘ add this
public class ConfigServerApplication {
```

*(The class already exists; youâ€™re only adding the annotation.)*

### 2.4Â Â Remove Version Tags

Maven **already** contains a `<dependencyManagement>` block.  
If any Springâ€‘Cloud starters show a `<version>` tag, delete it:

```xml
<!-- Before -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-bus-kafka</artifactId>
  <version>4.2.1</version>   <!-- remove -->
</dependency>

<!-- After -->
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-bus-kafka</artifactId>
</dependency>
```

### 2.5Â Â `application.properties`

Create/overwrite **`src/main/resources/application.properties`** *(replace `<your-username>` with your GitHub username)*:

```properties
server.port=8888
spring.application.name=config-server

spring.cloud.config.server.git.uri=https://github.com/<your-username>/config-repo
spring.cloud.bus.enabled=true
spring.cloud.stream.kafka.binder.brokers=localhost:9092

management.endpoints.web.exposure.include=health,info,refresh,busrefresh
```

### 2.6Â Â Run in IntelliJ

*Rightâ€‘click* **ConfigServerApplication.java â†’ Run**, **or** open IntelliJ Terminal:

```powershell
mvn spring-boot:run
```

Expected console tail:

```
... Started ConfigServerApplication in 6.0 seconds
... Tomcat started on port(s): 8888
```

---

## **PartÂ 3 â€“ ClientÂ Service (`user-service`)**

> **TechÂ Explainer â€” SpringÂ CloudÂ Bus (Client Side)**  
> Each microservice includes the SpringÂ CloudÂ Bus starter so it can publish & listen to events over Kafka. When the ConfigÂ Server broadcasts a **`RefreshRemoteApplicationEvent`**, every client automatically reloads its configuration.

### 3.1Â Â Create Project

| | Setting |
|-|---------|
| **Folder** | `C:\Projects\Lab09\user-service` |
| **Spring Initializr** | <https://start.spring.io> |
| **Group / Artifact / Name** | `com.microservices` / **user-service** / **user-service** |
| **Dependencies** | **CloudÂ Bus**, **ConfigÂ Client**, **Springâ€¯Bootâ€¯Actuator**, **SpringÂ Web** |

Download ZIP â†’ extract to the folder above.

### 3.2Â Â Open in IntelliJ  
(FileÂ â†’Â Openâ€¦ â†’ choose **user-service**).

### 3.3Â Â Remove Version Tags  
Delete any `<version>` elements on Springâ€‘Cloud starters as in Â§2.4.

### 3.4Â Â `application.properties`

```properties
server.port=8081
spring.application.name=user-service

spring.cloud.config.uri=http://localhost:8888
spring.cloud.bus.enabled=true
spring.cloud.stream.kafka.binder.brokers=localhost:9092

management.endpoints.web.exposure.include=health,info,refresh
```

### 3.5Â Â Add REST Controller

Create file **`src/main/java/com/microservices/userservice/ConfigController.java`**:

```java
package com.microservices.userservice;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RefreshScope
public class ConfigController {

    @Value("${message:Default message}")
    private String message;

    @GetMapping("/message")
    public String getMessage() {
        return message;
    }
}
```

### 3.6Â Â Run in IntelliJ

Run **UserServiceApplication** or:

```powershell
mvn spring-boot:run
```

Expected tail:

```
... Started UserServiceApplication in 5.0 seconds
```

### 3.7Â Â Test endpoint *(new PowerShellâ€¯Admin window)*

```powershell
curl http://localhost:8081/message
```

Output:

```
Default message
```

---

## **PartÂ 4 â€“ Broadcast Config Changes**

1. **Edit property file in GitHub Web UI**  
   Open `config-repo/user-service.properties` online â†’ click âœï¸â€¯**Edit** â†’ replace content with:  
   ```properties
   message=Hello from Config Server!
   ```  
   â†’ **Commit changes**.

2. **Trigger bus refresh** *(PowerShellâ€¯Admin)*  
   ```powershell
   curl -X POST http://localhost:8888/actuator/busrefresh
   ```
   Expected headers (no body):

   ```
   HTTP/1.1 204 No Content
   Date: <timestamp>
   ```

3. **Verify**  
   ```powershell
   curl http://localhost:8081/message
   ```
   Output:

   ```
   Hello from Config Server!
   ```

---

## **PartÂ 5 â€“ Second Client (`product-service`)**

Repeat **PartÂ 3** but with the values below.

| Setting | Value |
|---------|-------|
| **Artifact / Name** | `product-service` |
| **Port** | `8082` |
| **File in GitHub** | `product-service.properties` |

After running both services, execute:

```powershell
curl -X POST http://localhost:8888/actuator/busrefresh
curl http://localhost:8081/message   # â†’ Hello from Config Server!
curl http://localhost:8082/message   # â†’ Hello from Config Server!
```

---

## **Conclusion**

You now have:

* Kafkaâ€¯+â€¯ZooKeeper running on Windows.  
* A ConfigÂ Server pulling files from GitHub.  
* Two services that **autoâ€‘refresh** configuration via SpringÂ CloudÂ Bus.

A single `POST /actuator/busrefresh` updates every service instantly â€” no restarts, no redeploys. ğŸ‰
